<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Ana - T-Mobile Sentiment Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='project_ana.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üìä Project Ana</h1>
            <p>T-Mobile Sentiment Analysis Dashboard</p>
        </header>

        <div class="main-layout">
            <!-- Left: Chat Interface (Text Message Style) -->
            <div class="chat-panel">
                <div class="card">
                    <div class="card-header">
                        <div class="chat-header-content">
                            <div class="bot-avatar">ü§ñ</div>
                            <div>
                                <h2>Ana AI Assistant</h2>
                                <p class="status">‚óè Online</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="date-divider">Today</div>
                        <div class="message-bubble bot">
                            <div class="bubble-content">
                                <p>Hi! I'm Ana, your T-Mobile data analyst üëã</p>
                                <p>Loading your data now...</p>
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <input 
                            type="text" 
                            id="chatInput" 
                            class="message-input" 
                            placeholder="Message Ana..."
                            onkeypress="if(event.key==='Enter') sendMessage()"
                        >
                        <button class="send-btn" onclick="sendMessage()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Quick Action Buttons -->
                <div class="quick-actions">
                    <button class="quick-btn" onclick="quickPrompt('What do users like?')">
                        üëç What users like
                    </button>
                    <button class="quick-btn" onclick="quickPrompt('Top 5 places with best reviews')">
                        üèÜ Top locations
                    </button>
                    <button class="quick-btn" onclick="quickPrompt('Main complaints')">
                        ‚ö†Ô∏è Complaints
                    </button>
                    <button class="quick-btn" onclick="quickPrompt('Generate full report')">
                        üìä Full report
                    </button>
                </div>
            </div>

            <!-- Right: Dynamic Data Visualizations -->
            <div class="data-panel">
                <div id="dataDashboard" class="dashboard-content">
                    <div class="welcome-card">
                        <div class="welcome-icon">üìä</div>
                        <h3>Welcome to Project Ana</h3>
                        <p>Data is loading... Ask Ana a question to see insights!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000';
        let currentData = null;
        let conversationHistory = [];

        // Auto-load data
        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/load_and_analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.error) {
                    addBotMessage("Sorry, couldn't load data: " + data.error);
                    return;
                }

                data.results = data.results.slice(0, 100);
                currentData = data;
                
                addBotMessage(`‚úÖ Data loaded! I analyzed ${data.summary.total_comments} reviews. What would you like to know?`);
                showInitialDashboard();
            } catch (error) {
                addBotMessage("Error loading data: " + error.message);
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (!currentData) {
                addBotMessage("Please wait while I load the data...");
                return;
            }

            input.value = '';
            addUserMessage(message);

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        use_latest_data: true
                    })
                });

                const data = await response.json();
                
                removeTypingIndicator();
                addBotMessage(data.response);
                
                // Update visualizations based on question
                updateVisualization(message);

            } catch (error) {
                removeTypingIndicator();
                addBotMessage("Sorry, I encountered an error: " + error.message);
            }
        }

        // Quick prompt
        function quickPrompt(prompt) {
            document.getElementById('chatInput').value = prompt;
            sendMessage();
        }

        // Add user message
        function addUserMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble user';
            messageDiv.innerHTML = `
                <div class="bubble-content">${text}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Add bot message
        function addBotMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Format text with markdown-like styling
            const formattedText = formatBotMessage(text);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble bot';
            messageDiv.innerHTML = `
                <div class="bubble-content">${formattedText}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Format bot message
        function formatBotMessage(text) {
            // Bold text between **
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Lists
            text = text.replace(/^\*   (.*?)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            // Line breaks
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        // Typing indicator
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message-bubble bot typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="bubble-content">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        // Update visualization based on query
        function updateVisualization(query) {
            const dashboard = document.getElementById('dataDashboard');
            const lowerQuery = query.toLowerCase();

            if (lowerQuery.includes('what') && lowerQuery.includes('like')) {
                showPositiveReviews();
            } else if (lowerQuery.includes('top') || lowerQuery.includes('best')) {
                showTopLocations();
            } else if (lowerQuery.includes('complaint') || lowerQuery.includes('issue') || lowerQuery.includes('problem')) {
                showNegativeReviews();
            } else if (lowerQuery.includes('report') || lowerQuery.includes('overview')) {
                showFullReport();
            } else {
                showSentimentOverview();
            }
        }

        // Show initial dashboard
        function showInitialDashboard() {
            if (!currentData) return;
            
            const summary = currentData.summary;
            const labels = summary.label_distribution || {};
            const positive = (labels.positive || 0) + (labels['slightly positive'] || 0);
            const negative = (labels.negative || 0) + (labels['slightly negative'] || 0);
            const neutral = labels.neutral || 0;

            const dashboard = document.getElementById('dataDashboard');
            dashboard.innerHTML = `
                <div class="stats-overview">
                    <div class="stat-card positive">
                        <div class="stat-value">${positive}</div>
                        <div class="stat-label">Positive Reviews</div>
                    </div>
                    <div class="stat-card negative">
                        <div class="stat-value">${negative}</div>
                        <div class="stat-label">Negative Reviews</div>
                    </div>
                    <div class="stat-card neutral">
                        <div class="stat-value">${neutral}</div>
                        <div class="stat-label">Neutral Reviews</div>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Sentiment Distribution</h3>
                    <canvas id="mainChart"></canvas>
                </div>
            `;

            createDoughnutChart(positive, negative, neutral);
        }

        // Show positive reviews
        function showPositiveReviews() {
            const results = currentData.results.filter(r => r.sentiment_label.includes('positive')).slice(0, 6);
            const dashboard = document.getElementById('dataDashboard');
            
            dashboard.innerHTML = `
                <h3 class="section-title">üòä What Users Love</h3>
                <div class="reviews-grid">
                    ${results.map(r => `
                        <div class="review-card positive">
                            <div class="review-stars">${'‚≠ê'.repeat(5)}</div>
                            <p class="review-text">${r.full_text.substring(0, 150)}...</p>
                            <div class="review-meta">
                                <span>üìç ${r.city || 'Unknown'}, ${r.state || ''}</span>
                                <span class="score-badge">${r.sentiment_score.toFixed(1)}/5</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Show top locations
        function showTopLocations() {
            const locationMap = {};
            currentData.results.forEach(r => {
                if (!r.city) return;
                const key = `${r.city}, ${r.state}`;
                if (!locationMap[key]) {
                    locationMap[key] = { positive: 0, negative: 0, total: 0 };
                }
                locationMap[key].total++;
                if (r.sentiment_label.includes('positive')) locationMap[key].positive++;
                if (r.sentiment_label.includes('negative')) locationMap[key].negative++;
            });

            const topLocations = Object.entries(locationMap)
                .sort((a, b) => b[1].positive - a[1].positive)
                .slice(0, 5);

            const dashboard = document.getElementById('dataDashboard');
            dashboard.innerHTML = `
                <h3 class="section-title">üèÜ Top Performing Locations</h3>
                <div class="leaderboard">
                    ${topLocations.map(([location, stats], index) => `
                        <div class="leaderboard-item">
                            <div class="rank">${index + 1}</div>
                            <div class="location-info">
                                <div class="location-name">${location}</div>
                                <div class="location-stats">
                                    <span class="positive-count">‚úì ${stats.positive} positive</span>
                                    <span class="total-count">${stats.total} total reviews</span>
                                </div>
                            </div>
                            <div class="score-percent">${((stats.positive / stats.total) * 100).toFixed(0)}%</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Show negative reviews
        function showNegativeReviews() {
            const results = currentData.results.filter(r => r.sentiment_label.includes('negative')).slice(0, 6);
            const dashboard = document.getElementById('dataDashboard');
            
            dashboard.innerHTML = `
                <h3 class="section-title">‚ö†Ô∏è Issues to Address</h3>
                <div class="issues-list">
                    ${results.map(r => `
                        <div class="issue-item">
                            <div class="issue-severity high">High Priority</div>
                            <p class="issue-text">${r.full_text.substring(0, 200)}...</p>
                            <div class="issue-meta">
                                <span>üìç ${r.city || 'Unknown'}, ${r.state || ''}</span>
                                <span class="score-badge negative">${r.sentiment_score.toFixed(1)}/5</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Show full report
        function showFullReport() {
            showSentimentOverview();
        }

        // Show sentiment overview
        function showSentimentOverview() {
            const summary = currentData.summary;
            const labels = summary.label_distribution || {};
            const positive = (labels.positive || 0) + (labels['slightly positive'] || 0);
            const negative = (labels.negative || 0) + (labels['slightly negative'] || 0);
            const neutral = labels.neutral || 0;
            const total = summary.total_comments;

            const dashboard = document.getElementById('dataDashboard');
            dashboard.innerHTML = `
                <div class="report-overview">
                    <h3 class="section-title">üìä Sentiment Overview</h3>
                    <div class="stats-grid-large">
                        <div class="stat-card-large positive">
                            <div class="stat-icon">üòä</div>
                            <div class="stat-value">${((positive/total)*100).toFixed(1)}%</div>
                            <div class="stat-label">Positive</div>
                            <div class="stat-count">${positive} reviews</div>
                        </div>
                        <div class="stat-card-large negative">
                            <div class="stat-icon">üòû</div>
                            <div class="stat-value">${((negative/total)*100).toFixed(1)}%</div>
                            <div class="stat-label">Negative</div>
                            <div class="stat-count">${negative} reviews</div>
                        </div>
                        <div class="stat-card-large neutral">
                            <div class="stat-icon">üòê</div>
                            <div class="stat-value">${((neutral/total)*100).toFixed(1)}%</div>
                            <div class="stat-label">Neutral</div>
                            <div class="stat-count">${neutral} reviews</div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
            `;

            setTimeout(() => createBarChart(positive, negative, neutral), 100);
        }

        // Create doughnut chart
        function createDoughnutChart(positive, negative, neutral) {
            const ctx = document.getElementById('mainChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        data: [positive, negative, neutral],
                        backgroundColor: ['#e20074', '#666', '#ccc'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'bottom' } }
                }
            });
        }

        // Create bar chart
        function createBarChart(positive, negative, neutral) {
            const ctx = document.getElementById('overviewChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        data: [positive, negative, neutral],
                        backgroundColor: ['#e20074', '#666', '#ccc']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>